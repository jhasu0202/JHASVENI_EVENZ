<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Even'Z — Admin Panel</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root {
    --bg:#07060a; --card:rgba(40,6,68,0.72); --accent:#b700ff; --muted:#cfc6e8;
  }
  *{box-sizing:border-box;margin:0;padding:0;font-family:'Poppins',sans-serif;color:var(--muted)}
  body{background:linear-gradient(180deg,#06050a,#0b0612);min-height:100vh}
  .app{display:grid;grid-template-columns:260px 1fr;gap:18px;min-height:100vh;padding:18px}
  nav{background:linear-gradient(180deg,rgba(30,0,50,0.95),rgba(10,0,20,0.95));padding:20px;border-radius:12px}
  nav h2{color:var(--accent);margin-bottom:14px;font-size:1.05rem}
  .nav-item{padding:12px;border-radius:8px;margin-bottom:8px;cursor:pointer;color:#fff;display:flex;justify-content:space-between;align-items:center;opacity:0.95}
  .nav-item.active{background:rgba(183,0,255,0.09);box-shadow:0 8px 20px rgba(183,0,255,0.06)}
  header{display:flex;justify-content:space-between;align-items:center;padding:12px 18px;border-radius:12px;background:linear-gradient(90deg,#0d0218,#20002b)}
  header h1{color:var(--accent);font-size:1.05rem}
  button.btn{background:var(--accent);border:none;padding:8px 12px;border-radius:8px;color:#fff;cursor:pointer}
  button.ghost{background:transparent;border:1px solid rgba(183,0,255,0.12);color:var(--muted)}
  main{padding:20px;overflow:auto}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:18px}
  .card{background:var(--card);padding:16px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.5)}
  .card h3{color:#ffd9ff;margin-bottom:8px}
  .card p{font-weight:700;font-size:1.4rem}
  .table-wrap{background:var(--card);padding:12px;border-radius:10px;overflow:auto}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.03);font-size:0.95rem}
  th{color:#ffd9ff;font-weight:600}
  tr:hover{background:rgba(183,0,255,0.05)}
  footer{color:#aaa;text-align:center;margin-top:18px}
  .controls{display:flex;gap:8px;align-items:center}
  .search{padding:8px;border-radius:8px;border:none;background:#0f0b14;color:var(--muted)}
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:9999}
  .modal-content{background:#fff;color:#000;padding:20px;border-radius:10px;width:90%;max-width:400px}
  .modal-content h2{margin-bottom:10px;color:#b700ff}
  .modal-content input,.modal-content textarea{width:100%;padding:8px;margin-bottom:10px;border:1px solid #ccc;border-radius:6px}
  .modal-actions{display:flex;justify-content:flex-end;gap:10px}
  .modal-actions button{padding:8px 16px;border:none;border-radius:20px;cursor:pointer}
  .cancel{background:#ccc}
  .danger{background:#dc3545;color:#fff}
  .primary{background:#b700ff;color:#fff}
  @media(max-width:980px){.app{grid-template-columns:1fr}.grid{grid-template-columns:1fr}nav{display:none}}
</style>
</head>

<body>
<div class="app">
  <nav id="sidebar">
    <h2>Even'Z Admin</h2>
    <div class="nav-item active" data-view="overview">Overview</div>
    <div class="nav-item" data-view="users">Users</div>
    <div class="nav-item" data-view="events">Events</div>
    <div class="nav-item" data-view="bookings">Bookings</div>
    <div class="nav-item" data-view="coupons">Coupons</div>
    <div class="nav-item" data-view="feedback">Feedback</div>
    <div class="nav-item" data-view="analytics">Analytics</div>
    <div style="height:18px"></div>
    <div style="font-size:0.9rem;opacity:0.9">Signed in as <b id="adminName">...</b></div>
    <div style="margin-top:12px;display:flex;gap:8px;flex-direction:column">
      <button class="btn" id="logoutBtn">Logout</button>
      <a class="btn ghost" href="/api/admin/export/users.csv">Export Users</a>
    </div>
  </nav>

  <div>
    <header><h1 id="pageTitle">Overview</h1></header>

    <main>
      <!-- Overview -->
      <section id="view-overview" class="view">
<div class="grid">
  <div class="card"><h3>Total Users</h3><p id="k-users">0</p></div>
  <div class="card"><h3>Total Events</h3><p id="k-events">0</p></div>
  <div class="card"><h3>Total Bookings</h3><p id="k-bookings">0</p></div>
  <div class="card"><h3>Total Revenue</h3><p id="k-revenue">₹0</p></div>
</div>
<div class="card"><h3>Revenue Chart</h3><canvas id="chartRevenue" height="100"></canvas></div>

      </section>
      

      <!-- Users -->
      <section id="view-users" class="view" style="display:none">
        <h3>Users</h3>
        <div class="table-wrap">
          <table id="tableUsers"><thead><tr><th>ID</th><th>Username</th><th>Email</th><th>Actions</th></tr></thead><tbody></tbody></table>
        </div>
      </section>

      <!-- Events -->
      <section id="view-events" class="view" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h3>Events</h3>
          <button class="btn" onclick="openModal('modalAddEvent')">+ Add Event</button>
        </div>
        <div class="table-wrap">
          <table id="tableEvents"><thead><tr><th>ID</th><th>Name</th><th>City</th><th>Venue</th><th>Date</th><th>Actions</th></tr></thead><tbody></tbody></table>
        </div>
      </section>

      <!-- Bookings -->
      <section id="view-bookings" class="view" style="display:none">
        <h3>Bookings</h3>
        <div class="table-wrap">
          <table id="tableBookings"><thead><tr><th>ID</th><th>User</th><th>Event</th><th>Date</th><th>Price</th><th>Status</th></tr></thead><tbody></tbody></table>
        </div>
      </section>

      <!-- Coupons -->
      <section id="view-coupons" class="view" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h3>Coupons</h3>
          <button class="btn" onclick="openModal('modalAddCoupon')">+ Create Coupon</button>
        </div>
        <div class="table-wrap">
          <table id="tableCoupons"><thead><tr><th>ID</th><th>Code</th><th>Discount%</th><th>Expires</th></tr></thead><tbody></tbody></table>
        </div>
      </section>

      <!-- Feedback -->
      <section id="view-feedback" class="view" style="display:none">
        <h3>Feedback</h3>
        <div class="table-wrap">
          <table id="tableFeedback"><thead><tr><th>ID</th><th>User</th><th>Message</th><th>Status</th></tr></thead><tbody></tbody></table>
          <!-- Reply Feedback Modal -->
<div class="modal" id="modalReplyFeedback">
  <div class="modal-content">
    <h2>Reply to Feedback</h2>
    <textarea id="replyMessage" placeholder="Type your reply..."></textarea>
    <div class="modal-actions">
      <button class="primary" onclick="sendReply()">Send</button>
      <button class="cancel" onclick="closeModal('modalReplyFeedback')">Cancel</button>
    </div>
  </div>
</div>
        </div>
      </section>

      <!-- Analytics -->
      <section id="view-analytics" class="view" style="display:none">
        <div class="grid">
          <div class="card"><h3>Plans</h3><canvas id="chartPlans" height="120"></canvas></div>
          <div class="card"><h3>Cities</h3><canvas id="chartCities" height="120"></canvas></div>
        </div>
      </section>

      <footer>© 2025 Even'Z Admin — Integrated with OracleDB</footer>
    </main>
  </div>
</div>

<!-- ================= MODALS ================= -->
<!-- Add Event -->
<div class="modal" id="modalAddEvent">
  <div class="modal-content">
    <h2>Add Event</h2>
    <input id="eventName" placeholder="Event Name">
    <textarea id="eventDesc" placeholder="Description"></textarea>
    <input id="eventDate" type="date">
    <input id="eventCity" placeholder="City">
    <input id="eventVenue" placeholder="Venue">
    <div class="modal-actions">
      <button class="primary" onclick="createEvent()">Create</button>
      <button class="cancel" onclick="closeModal('modalAddEvent')">Cancel</button>
    </div>
  </div>
</div>

<!-- Edit Event -->
<div class="modal" id="modalEditEvent">
  <div class="modal-content">
    <h2>Edit Event</h2>
    <input id="editEventName">
    <input id="editEventCity">
    <input id="editEventVenue">
    <input id="editEventDate" type="date">
    <div class="modal-actions">
      <button class="primary" onclick="updateEvent()">Save</button>
      <button class="cancel" onclick="closeModal('modalEditEvent')">Cancel</button>
    </div>
  </div>
</div>

<!-- Edit User -->
<div class="modal" id="modalEditUser">
  <div class="modal-content">
    <h2>Edit User</h2>
    <input id="editUserName" placeholder="Full Name">
    <input id="editUserEmail" placeholder="Email">
    <div class="modal-actions">
      <button class="primary" onclick="updateUser()">Save</button>
      <button class="cancel" onclick="closeModal('modalEditUser')">Cancel</button>
    </div>
  </div>
</div>

<!-- Add Coupon -->
<div class="modal" id="modalAddCoupon">
  <div class="modal-content">
    <h2>Create Coupon</h2>
    <input id="couponCode" placeholder="Code (e.g. FEST20)">
    <input id="couponDiscount" type="number" placeholder="Discount %">
    <input id="couponExpiry" type="date">
    <div class="modal-actions">
      <button class="primary" onclick="createCoupon()">Create</button>
      <button class="cancel" onclick="closeModal('modalAddCoupon')">Cancel</button>
    </div>
  </div>
</div>

<script>
const $ = (s)=>document.querySelector(s);
const $$=(s)=>Array.from(document.querySelectorAll(s));
let editUserId=null, editEventId=null;

async function apiGET(u){return(await fetch(u)).json();}
async function apiPOST(u,b){return(await fetch(u,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(b)})).json();}
async function apiPUT(u,b){return(await fetch(u,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(b)})).json();}
async function apiDELETE(u){return(await fetch(u,{method:"DELETE"})).json();}

/* --- Navigation --- */
$$(".nav-item").forEach(it=>it.addEventListener("click",()=>{
  $$(".nav-item").forEach(x=>x.classList.remove("active"));
  it.classList.add("active");
  const v=it.dataset.view;
  $$(".view").forEach(s=>s.style.display="none");
  $("#view-"+v).style.display="block";
  $("#pageTitle").textContent=v.charAt(0).toUpperCase()+v.slice(1);
}));

/* --- Overview --- */
async function loadOverview(){
  const r = await apiGET("/api/admin/overview");

  $("#k-users").textContent = r.stats?.totalUsers ?? 0;
  $("#k-events").textContent = r.stats?.totalEvents ?? 0;
  $("#k-bookings").textContent = r.stats?.totalBookings ?? 0;
  $("#k-revenue").textContent = "₹" + (r.stats?.totalRevenue ?? 0).toLocaleString();

  if (r.charts) renderCharts(r.charts);
}

/* --- Charts --- */
let chartRevenue, chartPlans, chartCities;
function renderCharts(data) {
  if (chartRevenue) chartRevenue.destroy();
  if (chartPlans) chartPlans.destroy();
  if (chartCities) chartCities.destroy();

  chartRevenue = new Chart(document.getElementById("chartRevenue"), {
    type: "line",
    data: {
      labels: data.revenue.labels,
      datasets: [{
        label: "Revenue (₹)",
        data: data.revenue.values,
        borderColor: "#b700ff",
        fill: false,
        tension: 0.3
      }]
    },
    options: {
      scales: {
        x: { ticks: { color: "#ccc" } },
        y: { ticks: { color: "#ccc" } }
      },
      plugins: { legend: { labels: { color: "#ccc" } } }
    }
  });

  chartPlans = new Chart(document.getElementById("chartPlans"), {
    type: "pie",
    data: {
      labels: data.plans.labels,
      datasets: [{
        label: "Plans",
        data: data.plans.values,
        backgroundColor: ["#b700ff", "#6a00b0", "#330055", "#ff00cc"]
      }]
    },
    options: { plugins: { legend: { labels: { color: "#ccc" } } } }
  });

  chartCities = new Chart(document.getElementById("chartCities"), {
    type: "bar",
    data: {
      labels: data.cities.labels,
      datasets: [{
        label: "Events per City",
        data: data.cities.values,
        backgroundColor: "#b700ff"
      }]
    },
    options: {
      scales: {
        x: { ticks: { color: "#ccc" } },
        y: { ticks: { color: "#ccc" } }
      },
      plugins: { legend: { labels: { color: "#ccc" } } }
    }
  });
}

/* --- Feedback --- */
let currentFeedbackId = null;
async function loadFeedback() {
  const r = await apiGET("/api/admin/feedback");
  const tb = $("#tableFeedback tbody");
  tb.innerHTML = "";
  
  r.feedback.forEach(f => {
    tb.innerHTML += `
      <tr>
        <td>${f.FEEDBACK_ID}</td>
        <td>${f.USERNAME || f.USER_ID}</td>
        <td>${f.MESSAGE}</td>
        <td>${f.STATUS}</td>
        <td>
          <button class="btn ghost" onclick="openReply(${f.FEEDBACK_ID})">Reply</button>
        </td>
      </tr>`;
  });
}

function openReply(id) {
  currentFeedbackId = id;
  $("#replyMessage").value = "";
  openModal("modalReplyFeedback");
}

async function sendReply() {
  const reply = $("#replyMessage").value.trim();
  if (!reply) return alert("Reply cannot be empty.");

  const res = await apiPOST(`/api/admin/feedback/${currentFeedbackId}/reply`, { reply });
  alert(res.success ? "Reply sent!" : res.message);
  closeModal("modalReplyFeedback");
  loadFeedback();
}

/* --- Users --- */
async function loadUsers(){
  const r=await apiGET("/api/admin/users");
  const tb=$("#tableUsers tbody");tb.innerHTML="";
  r.users.forEach(u=>{
    tb.innerHTML+=`<tr><td>${u.ID}</td><td>${u.USERNAME}</td><td>${u.EMAIL}</td>
    <td><button class='btn ghost' onclick='editUser(${u.ID},"${u.FULLNAME}","${u.EMAIL}")'>Edit</button>
    <button class='btn danger' onclick='deleteUser(${u.ID})'>Delete</button></td></tr>`;
  });
}
function editUser(id,name,email){
  editUserId=id;
  $("#editUserName").value=name;
  $("#editUserEmail").value=email;
  openModal("modalEditUser");
}
async function updateUser(){
  const data={FULLNAME:$("#editUserName").value,EMAIL:$("#editUserEmail").value};
  const r=await apiPUT(`/api/admin/users/${editUserId}`,data);
  alert(r.success?"Updated!":"Failed");
  closeModal("modalEditUser");loadUsers();
}
async function deleteUser(id){
  if(!confirm("Delete this user?"))return;
  const r=await apiDELETE(`/api/admin/users/${id}`);
  alert(r.success?"User deleted!":"Failed");
  loadUsers();
}

/* --- Events --- */
async function loadEvents(){
  const r=await apiGET("/api/admin/events");
  const tb=$("#tableEvents tbody");tb.innerHTML="";
  r.events.forEach(e=>{
    tb.innerHTML+=`<tr><td>${e.ID}</td><td>${e.NAME}</td><td>${e.CITY}</td><td>${e.VENUE}</td><td>${e.EVENT_DATE}</td>
    <td><button class='btn ghost' onclick='editEvent(${e.ID},"${e.NAME}","${e.CITY}","${e.VENUE}","${e.EVENT_DATE}")'>Edit</button>
    <button class='btn danger' onclick='deleteEvent(${e.ID})'>Delete</button></td></tr>`;
  });
}
function editEvent(id,name,city,venue,date){
  editEventId=id;
  $("#editEventName").value=name;
  $("#editEventCity").value=city;
  $("#editEventVenue").value=venue;
  $("#editEventDate").value=date.split("T")[0];
  openModal("modalEditEvent");
}
async function updateEvent(){
  const data={NAME:$("#editEventName").value,CITY:$("#editEventCity").value,VENUE:$("#editEventVenue").value,EVENT_DATE:$("#editEventDate").value};
  const r=await apiPUT(`/api/admin/events/${editEventId}`,data);
  alert(r.success?"Event updated!":"Failed");
  closeModal("modalEditEvent");loadEvents();
}
async function createEvent(){
  const e={NAME:$("#eventName").value,DESCRIPTION:$("#eventDesc").value,EVENT_DATE:$("#eventDate").value,CITY:$("#eventCity").value,VENUE:$("#eventVenue").value};
  const r=await apiPOST("/api/admin/events",e);
  alert(r.success?"Event added!":"Failed");
  closeModal("modalAddEvent");loadEvents();
}
async function deleteEvent(id){
  if(!confirm("Delete this event?"))return;
  const r=await apiDELETE(`/api/admin/events/${id}`);
  alert(r.success?"Deleted!":"Failed");
  loadEvents();
}

/* --- Bookings --- */
async function loadBookings(){
  const r=await apiGET("/api/admin/bookings");
  const tb=$("#tableBookings tbody");tb.innerHTML="";
  r.bookings.forEach(b=>{
    tb.innerHTML+=`<tr><td>${b.ID}</td><td>${b.USERNAME}</td><td>${b.EVENT_NAME}</td><td>${b.BOOKING_DATE}</td><td>₹${b.PRICE}</td><td>${b.STATUS}</td></tr>`;
  });
}

/* --- Coupons --- */
async function loadCoupons(){
  const r=await apiGET("/api/admin/coupons");
  const tb=$("#tableCoupons tbody");tb.innerHTML="";
  r.coupons.forEach(c=>{
    tb.innerHTML+=`<tr><td>${c.ID}</td><td>${c.CODE}</td><td>${c.DISCOUNT_PERCENT}</td><td>${c.EXPIRES_AT}</td></tr>`;
  });
}
async function createCoupon(){
  const c={CODE:$("#couponCode").value,DISCOUNT_PERCENT:$("#couponDiscount").value,EXPIRES_AT:$("#couponExpiry").value};
  const r=await apiPOST("/api/admin/coupons",c);
  alert(r.success?"Coupon created!":"Failed");
  closeModal("modalAddCoupon");loadCoupons();
}

/* --- Logout --- */
document.getElementById("logoutBtn").addEventListener("click",()=>{
  if(confirm("Are you sure you want to logout?")) window.location.href="Loginpage.html";
});

/* --- Helpers --- */
function openModal(id){$("#"+id).style.display="flex";}
function closeModal(id){$("#"+id).style.display="none";}

/* --- Init --- */
(async function init(){
  loadOverview();
  loadUsers();
  loadEvents();
  loadBookings();
  loadCoupons();
  loadFeedback();
})();
</script>
</body>
</html>

